<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EXAM VAULT - Neumorphism Style</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --bg-light: #e0e5ec;
      --bg-component: #f0f3f6;
      --shadow-dark: #a3b1c6;
      --shadow-light: #ffffff;
      --accent-color: #007bff;
      --text-main: #333333;
      --text-highlight: #000000;
      --primary-action: #28a745;
      --ad-bg: #fff3cd;
      --ad-text: #856404;
      --ad-right-bg: #d1ecf1; 
      --ad-right-text: #0c5460;
      --bottom-ad-bg: #e2f3f5;
      --bottom-ad-text: #222831;
      --star-color: #f39c12;
      --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* --- Base & Typography --- */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0; padding: 0;
      background: var(--bg-light); color: var(--text-main);
      min-height: 100vh; display: flex; flex-direction: column;
      transition: background 0.4s ease-in-out; line-height: 1.6;
    }

    h1, h2 {
      font-weight: 700; color: var(--text-highlight);
      margin-top: 0; margin-bottom: 0.75rem; letter-spacing: 0.5px;
    }
    
    .page h2 { text-align: center; margin-bottom: 2rem; }
    p { margin-top: 0; }

    /* --- Header & Nav --- */
    header {
      background: var(--bg-component); color: var(--text-highlight);
      padding: 1.5rem 2rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 1rem; 
    }
    
    .header-title { 
      text-align: left; 
      cursor: pointer;
    }
    .header-title p { margin-bottom: 0; opacity: 0.8; }

    nav { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    nav a {
      color: var(--text-main); margin: 0 0.5rem; padding: 10px 20px;
      text-decoration: none; font-weight: 600; border-radius: 20px;
      transition: all 0.4s var(--ease-out-back);
      background: var(--bg-light);
      box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
    }
    nav a:hover {
      color: var(--accent-color);
      box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
      transform: translateY(-3px) scale(1.05);
    }

    /* --- Smart Search Bar --- */
    .search-container {
      flex-grow: 1; max-width: 400px; position: relative;
    }
    #search-bar {
      padding: 12px 20px 12px 45px; width: 100%; box-sizing: border-box;
      border: none; border-radius: 25px; background: var(--bg-light);
      color: var(--text-main); transition: box-shadow 0.3s ease-in-out;
      box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light);
    }
    #search-bar:focus { outline: none; box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light), 0 0 0 3px var(--accent-color); }
    .search-container .fa-search {
      position: absolute; left: 18px; top: 50%;
      transform: translateY(-50%); color: var(--text-main); opacity: 0.6;
    }
    #search-results {
      position: absolute; top: 110%; left: 0; right: 0; background: var(--bg-component);
      border-radius: 15px; box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light);
      z-index: 100; max-height: 300px; overflow-y: auto;
    }
    .search-result-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--bg-light); }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: var(--bg-light); }
    .search-result-item small { opacity: 0.7; display: block; }

    /* --- Main Layout --- */
    .main-layout {
        display: grid; grid-template-columns: 260px 1fr 260px;
        flex-grow: 1; width: 100%; max-width: 1500px;
        margin: 0 auto; padding: 2rem; box-sizing: border-box; gap: 2rem; 
        align-items: start; /* <-- THIS IS THE FIX */
    }

    /* --- Side Ad Bars --- */
    .ad-sidebar {
      transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      opacity: 0; pointer-events: none;
    }
    #ad-sidebar { transform: translateX(-30px); }
    #ad-sidebar-right { transform: translateX(30px); }
    .ad-sidebar.visible { opacity: 1; transform: translateX(0); pointer-events: auto; }

    .ad-block-wrapper {
      height: fit-content; min-height: 300px; padding: 1.5rem; text-align: center; border-radius: 15px;
      box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
      font-size: 0.95rem; font-weight: 600;
      display: flex; flex-direction: column; justify-content: center;
    }
    #ad-block { background: var(--ad-bg); color: var(--ad-text); }
    #ad-block-right { background: var(--ad-right-bg); color: var(--ad-right-text); }
    #ad-block p, #ad-block-right p { margin: 0 0 1rem 0; font-size: 1rem; line-height: 1.5; }
    #ad-block .support-btn {
      background: var(--accent-color); color: white; border: none; padding: 10px 22px;
      margin-top: 10px; border-radius: 25px; font-weight: 700; cursor: pointer; 
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2); 
      transition: all 0.4s var(--ease-out-back);
    }
    #ad-block .support-btn:hover {
      background: #0056b3; transform: translateY(-4px) scale(1.05);
      box-shadow: inset 1px 1px 3px var(--shadow-dark), inset -1px -1px 3px var(--shadow-light), 0 5px 10px rgba(0,0,0,0.2);
    }

    /* --- Page Container & Animations --- */
    .container { min-width: 0; perspective: 1500px; }
    .page { display: none; }

    .page.visible {
      display: block;
      animation: creativePageIn 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    .page.is-exiting {
      animation: creativePageOut 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
    }
    
    @keyframes creativePageIn {
      from { opacity: 0; transform: translate3d(0, 80px, -200px) rotateX(45deg) scale(0.9); filter: blur(6px); }
      to { opacity: 1; transform: translate3d(0, 0, 0) rotateX(0deg) scale(1); filter: blur(0); }
    }
    @keyframes creativePageOut {
      from { opacity: 1; transform: translate3d(0, 0, 0) rotateX(0deg) scale(1); filter: blur(0); }
      to { opacity: 0; transform: translate3d(0, -40px, -150px) rotateX(-20deg) scale(0.95); filter: blur(6px); }
    }

    /* --- Interactive Components --- */
    .card {
      background: var(--bg-component); border-radius: 18px;
      padding: 1.5rem; margin-bottom: 1.5rem;
      box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light);
      cursor: pointer; 
      transition: all 0.4s var(--ease-out-back);
      transform: translateY(0); text-align: center;
      opacity: 0; /* Set by JS animation */
    }
    .card:last-child { margin-bottom: 0; }
    .card:hover {
      transform: translateY(-8px) scale(1.04);
      box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
    }
    
    @keyframes cardFadeInUp {
        from { opacity: 0; transform: translateY(40px) scale(0.9) rotate(-4deg); }
        to { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
    }

    .card a {
      color: var(--text-main); text-decoration: none; display: block;
      transition: color 0.3s ease-in-out; font-weight: 600;
    }
    #semesters .card, #subjects .card, #units .card {
        color: var(--text-highlight); font-weight: 700;
    }

    /* --- Subject Page --- */
    .subject-actions {
      display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap;
    }
    .subject-actions .action-btn {
      background: var(--bg-component); color: var(--text-main); font-weight: 600;
      padding: 12px 24px; border-radius: 25px; cursor: pointer;
      box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
      transition: all 0.4s var(--ease-out-back);
    }
    .subject-actions .action-btn:hover {
      color: var(--accent-color); transform: translateY(-3px) scale(1.05);
      box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
    }
    
    /* Subject Analysis Page Layout */
    .analysis-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        align-items: center;
    }

    /* --- PYQ List & Rating Styles --- */
    .pyq-item {
      background: var(--bg-component); border-radius: 18px; padding: 1.5rem;
      margin-bottom: 1.5rem; text-align: left;
      box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light);
      opacity: 0; /* For animation */
    }
    .pyq-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .pyq-title { font-weight: 700; font-size: 1.1rem; }
    .pyq-tags { display: flex; gap: 0.5rem; }
    .pyq-tag { background: var(--bg-light); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
    .pyq-actions { display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
    .pyq-btn {
      flex-grow: 1; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer;
      background: var(--bg-light); color: var(--text-main);
      box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
      transition: all 0.3s var(--ease-out-back);
    }
    .pyq-btn:hover { color: var(--accent-color); box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light); }
    .pyq-btn.primary { background: var(--accent-color); color: white; }
    .pyq-btn.primary:hover { background: #0056b3; color: white; }
    
    .rating-comment-section { display: none; margin-top: 1.5rem; }
    .stars { font-size: 1.5rem; cursor: pointer; color: #ccc; }
    .stars .fa-star { transition: color 0.2s ease; }
    .stars .fa-star:hover { color: var(--star-color); }
    .stars .fa-star.selected { color: var(--star-color); }
    .comment-box { margin-top: 1rem; }
    textarea { width: 100%; padding: 10px; border-radius: 10px; border: none; background: var(--bg-light);
              box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light);
              min-height: 80px; box-sizing: border-box; }
    
    /* --- Question Bank & Leaderboard Styles --- */
    .question-bank-filters { display: flex; gap: 1rem; margin-bottom: 2rem; justify-content: center; }
    .question-item { text-align: left; margin-bottom: 1rem; padding: 1.2rem; background: var(--bg-light); border-radius: 12px; }
    .leaderboard-table { width: 100%; border-collapse: collapse; }
    .leaderboard-table th, .leaderboard-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--bg-light); }
    .leaderboard-table thead { background: var(--bg-component); }
    .leaderboard-table th { font-weight: 700; }
    .leaderboard-table .rank { font-weight: 700; text-align: center; }
    .leaderboard-table .fa-medal { color: gold; }
    .leaderboard-table .social-link { color: var(--accent-color); text-decoration: none; }
    .leaderboard-table .social-link:hover { text-decoration: underline; }

    /* --- Exam Simulator Modal --- */
    .exam-simulator-modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
      align-items: center; justify-content: center;
    }
    .exam-simulator-content {
      background: var(--bg-component); padding: 2rem; border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 800px;
      text-align: center;
    }
    #sim-timer { font-size: 2.5rem; font-weight: 700; margin: 1rem 0; color: var(--accent-color); }
    #sim-paper-view { height: 400px; background: var(--bg-light); border-radius: 10px;
                      display: flex; align-items: center; justify-content: center; font-style: italic; color: #888; margin: 1rem 0; }
    .sim-controls { display: flex; gap: 1rem; justify-content: center; }


    /* --- Forms, Layouts, Footer --- */
    #semesters { display: flex; gap: 1.5rem; justify-content: center; }
    .semester-column { display: flex; flex-direction: column; gap: 1.5rem; flex: 1; }
    
    label { font-weight: 600; display: block; margin: 1.5rem 0 0.5rem 0; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem; }
    
    .checkbox-label label {
      font-weight: 400;
      display: initial;
      margin: 0;
    }
    
    /* FIX: Excluded checkboxes from the 100% width rule to prevent layout breaking */
    input:not([type="checkbox"]), select {
      padding: 14px;
      width: 100%;
      box-sizing: border-box;
      border: none;
      border-radius: 10px;
      background: var(--bg-light);
      color: var(--text-main);
      transition: box-shadow 0.3s ease-in-out;
      box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light);
    }
    input:focus, select:focus {
      box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light), 0 0 0 3px var(--accent-color);
      outline: none;
    }
    button {
      background: var(--primary-action); border: none; padding: 14px 28px;
      color: white; border-radius: 30px; cursor: pointer; font-weight: 700;
      margin-top: 2rem; box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
      text-transform: uppercase; letter-spacing: 1px;
      transition: all 0.4s var(--ease-out-back);
      transform: translateY(0);
    }
    button:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: inset 3px 3px 6px rgba(0,0,0,0.1), inset -3px -3px 6px var(--shadow-light), 0 7px 14px rgba(0,0,0,0.2);
    }
    .page button.back-btn {
      background: var(--bg-component); color: var(--text-main);
      box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
    }
    .page button.back-btn:hover { 
        color: var(--accent-color); 
        box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        transform: translateY(-3px);
    }
    
    footer {
      background: var(--bg-component); color: var(--text-main); text-align: center;
      padding: 1.5rem; margin-top: auto;
      box-shadow: inset 3px 3px 7px var(--shadow-dark), inset -3px -3px 7px var(--shadow-light);
    }
    
    /* --- Responsive Adjustments --- */
    @media (max-width: 1200px) {
        .main-layout { grid-template-columns: 1fr; }
        .ad-sidebar { display: none; }
    }
     @media (max-width: 992px) {
        .analysis-layout { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
        header { flex-direction: column; text-align: center; }
        .search-container { max-width: 100%; margin-top: 1rem; }
        nav { justify-content: center; }
        .main-layout { padding: 1rem; }
        #semesters { flex-direction: column; }
    }
  </style>
</head>
<body>

<header>
  <div class="header-title" onclick="showPage('home')">
    <h1>🎓 EXAM VAULT</h1>
    <p>SRM B.TECH ECE - R2021 CURRICULUM</p>
  </div>
    <div class="search-container">
      <i class="fas fa-search"></i>
      <input type="text" id="search-bar" placeholder="Search for subjects, topics..." onkeyup="handleSearch()">
      <div id="search-results" style="display: none;"></div>
  </div>
  <nav>
    <a href="#" onclick="showPage('home')">Home</a>
    <a href="#" onclick="showPage('leaderboardPage')">Leaders</a>
    <a href="#" onclick="showPage('upload')">Upload</a>
    <a href="#" onclick="showPage('about')">About</a>
  </nav>
</header>

<main class="main-layout">
 
  <aside id="ad-sidebar" class="ad-sidebar">
      <div id="ad-block" class="ad-block-wrapper"></div>
  </aside>

  <div class="container">
    <div id="home" class="page visible">
      <h2>Select Semester</h2>
      <div id="semesters">
        <div id="semester-col-1" class="semester-column"></div>
        <div id="semester-col-2" class="semester-column"></div>
      </div>
    </div>
    <div id="semesterPage" class="page">
      <h2 id="semesterTitle"></h2>
      <div id="subjects"></div>
      <button class="back-btn" onclick="showPage('home')">⬅ Back to Home</button>
    </div>
    <div id="subjectPage" class="page">
      <h2 id="subjectTitle"></h2>
      <div class="subject-actions">
          <div class="action-btn" onclick="showSubjectAnalysis(currentSubject)"><i class="fas fa-chart-pie"></i> View Analysis</div>
          <div class="action-btn" onclick="showQuestionBank(currentSubject)"><i class="fas fa-list-alt"></i> Question Bank</div>
      </div>
      <div id="units"></div>
      <button class="back-btn" onclick="showSemester(currentSemester)">⬅ Back to Subjects</button>
    </div>
    <div id="unitPage" class="page">
      <h2 id="unitTitle"></h2>
      <div id="pyqList"></div>
      <button class="back-btn" onclick="showSubject(currentSemester, currentSubject)">⬅ Back to Units</button>
    </div>
    <div id="subjectAnalysisPage" class="page">
        <h2 id="analysisTitle"></h2>
        <div class="analysis-layout">
            <div style="background: var(--bg-component); padding: 1.5rem; border-radius: 15px; box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light);">
                <h3>Unit Weightage</h3>
                <canvas id="unitWeightageChart"></canvas>
            </div>
            <div style="background: var(--bg-component); padding: 1.5rem; border-radius: 15px; box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light);">
                <h3>Important Topics Frequency</h3>
                <canvas id="topicChart"></canvas>
            </div>
        </div>
        <button class="back-btn" onclick="showSubject(currentSemester, currentSubject)">⬅ Back to Units</button>
    </div>
    <div id="questionBankPage" class="page">
        <h2 id="questionBankTitle"></h2>
        <div class="question-bank-filters">
            <select id="unitFilter" onchange="renderQuestionBank(currentSubject)">
                <option value="all">All Units</option>
            </select>
        </div>
        <div id="questionBankList"></div>
        <button class="back-btn" onclick="showSubject(currentSemester, currentSubject)">⬅ Back to Units</button>
    </div>
    <div id="leaderboardPage" class="page">
        <h2>🏆 Top Contributors</h2>
        <div class="card" style="text-align: left; opacity: 1;">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th class="rank">Rank</th>
                        <th>User</th>
                        <th>Points</th>
                        <th>Uploads</th>
                        <th>Social</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
        <button class="back-btn" onclick="showPage('home')">⬅ Back to Home</button>
    </div>
    <div id="upload" class="page">
      <h2>📤 Upload PYQ</h2>
      <form onsubmit="event.preventDefault(); handleSuccessfulUpload();">
        <label for="upload-sem">Select Semester</label>
        <select id="upload-sem" onchange="populateUploadSubjects()" required>
          <option value="">-- Select Semester --</option>
        </select>
        <label for="upload-sub">Select Subject Name</label>
        <select id="upload-sub" onchange="populateUploadUnits()" disabled required><option value="">-- Select Subject --</option></select>
        <label for="upload-unit">Select Unit/Module Name</label>
        <select id="upload-unit" disabled required><option value="">-- Select Unit --</option></select>
        <label for="upload-file">Upload File (PDF Only)</label>
        <input id="upload-file" type="file" required accept=".pdf">
        <div class="checkbox-label">
            <input type="checkbox" id="feature-me" checked>
            <label for="feature-me">Feature my contribution on the Leaderboard!</label>
        </div>
        <button type="submit">Upload Paper</button>
      </form>
    </div>
    <div id="about" class="page">
      <h2>💡 About EXAM VAULT</h2>
      <div class="card" style="text-align: left; opacity: 1; max-width: 800px; margin: 0 auto;">
          <p>This platform simplifies access to <strong>Previous Year Question Papers (PYQs)</strong> for SRM B.Tech ECE (R2021) students. Our goal is to create a centralized, easy-to-use hub for all your exam preparation needs.</p>
          <h4>Key Features:</h4>
          <ul>
            <li><strong>Intuitive Navigation:</strong> Easily browse papers by semester, subject, and unit.</li>
            <li><strong>Exam Simulator:</strong> Practice solving papers with a built-in 3-hour timer to simulate real exam conditions.</li>
            <li><strong>Subject Analysis:</strong> Get insights with charts showing unit-wise mark weightage and frequency of important topics.</li>
            <li><strong>Question Bank:</strong> Access a curated list of important questions for each subject, filterable by unit.</li>
            <li><strong>Community Feedback:</strong> Rate papers and leave comments to help your peers identify the most relevant material.</li>
            <li><strong>Contributor Leaderboard:</strong> See who the top contributors are and get recognized for your uploads.</li>
          </ul>
          <p>Upload papers to help the community and get an <strong>AD-FREE experience!</strong> Made with 💙 as a College Project (2025).</p>
      </div>
    </div>
  </div>
 
  <aside id="ad-sidebar-right" class="ad-sidebar">
      <div id="ad-block-right" class="ad-block-wrapper">
          <div>
              <p><strong>Top Rankers Use This!</strong></p>
              <p>Get instant access to verified notes and study guides. Ace your exams!</p>
              <a href="#" style="color: var(--ad-right-text);">Learn More</a>
          </div>
      </div>
  </aside>
</main>

<div id="exam-simulator" class="exam-simulator-modal">
    <div class="exam-simulator-content">
        <h2>Exam Practice Mode</h2>
        <p id="sim-paper-title"></p>
        <div id="sim-timer">03:00:00</div>
        <div id="sim-paper-view">
            <p>Simulated PDF view of the paper appears here.</p>
        </div>
        <div class="sim-controls">
            <button class="pyq-btn" onclick="toggleTimer()"><i class="fas fa-pause"></i><span id="pause-btn-text"> Pause</span></button>
            <button class="pyq-btn" onclick="stopExamSimulator()">End Session</button>
        </div>
    </div>
</div>

<footer>
  <p>© 2025 EXAM VAULT | College Project | <a href="#" onclick="localStorage.clear(); alert('Ad-free status reset! Refreshing...'); location.reload();" style="color: var(--accent-color);">Reset Ad Status</a></p>
</footer>

<script>
// The rest of your Javascript remains exactly the same...
// --- GLOBAL STATE ---
let currentSemester = "";
let currentSubject = "";
let currentUnit = "";
let topicChartInstance = null;
let unitChartInstance = null;
let examTimerInterval = null;
let remainingTime = 3 * 60 * 60;
let isPaused = false;

// --- DATABASE FROM SYLLABUS ---
const pyqs = {
    "Semester 1": {
        "21CYM101T": { name: "Engineering Chemistry", units: {} },
        "21MAB101T": { name: "Calculus and Linear Algebra", units: {} },
        "21CSE101T": { name: "Problem Solving & C Programming", units: {} },
        "21EBE101T": { name: "Basic Electrical and Electronics", units: {} }
    },
    "Semester 2": {
        "21PYM101T": { name: "Physics: EM Theory & Quantum Mech", units: {} },
        "21MAB102T": { name: "Differential Equations & Transforms", units: {} },
        "21EPL101L": { name: "English for Professional Communication", units: {} },
        "21CSE102J": { name: "Data Structures Using C", units: {} }
    },
    "Semester 3": {
        "21ECC201T": { name: "Solid State Devices", units: {} },
        "21ECC202T": { name: "Analog and Linear Electronic Circuits", units: {} },
        "21ECC203T": { name: "Digital Logic Design", units: {} },
        "21ECC204T": { name: "Signal Processing", units: {} },
        "21ECC205T": { name: "Electromagnetic Theory and Interference", units: {} }
    },
    "Semester 4": {
        "21ECC401T": { name: "Wireless Communication and Antenna Systems", units: {} },
        "21ECC402P": { name: "Computer Communication and Network Security", units: {} },
        "21ECE201J": { name: "Python and Scientific Python", units: {} },
        "21ECE202T": { name: "Micro-and Nano-Fabrication Technologies", units: {} },
        "21ECE203J": { name: "Smart Sensors and Devices for Agriculture", units: {} }
    },
    "Semester 5": {
        "21ECC301T": { name: "Digital Signal Processing", units: {} },
        "21ECC302T": { name: "VLSI Design", units: {} },
        "21ECC303T": { name: "Control Systems Engineering", units: {} },
        "21ECC304T": { name: "Computer Architecture", units: {} }
    },
    "Semester 6": {
        "21ECC305T": { name: "Embedded Systems", units: {} },
        "21ECC306T": { name: "Microwave Engineering", units: {} },
        "21ECC307T": { name: "Optical Communication", units: {} },
        "21ECE401T": { name: "Professional Elective I", units: {} }
    },
    "Semester 7": {
        "21ECE405T": { name: "IoT and Edge Computing", units: {} },
        "21ECE406T": { name: "Machine Learning for ECE", units: {} },
        "21ECE402T": { name: "Professional Elective II", units: {} },
        "21EGP501P": { name: "Project Work - Phase I", units: {} }
    },
    "Semester 8": {
        "21EGP502P": { name: "Project Work - Phase II", units: {} },
        "21EGP503P": { name: "Internship / Capstone", units: {} },
        "21EGP504V": { name: "Comprehensive Examination", units: {} }
    }
};

const unitData = {
    // Sem 1
    "21CYM101T": ["Atomic & Molecular Structure", "Spectroscopic Techniques", "Intermolecular Forces", "Thermodynamics", "Periodic Properties"],
    "21MAB101T": ["Matrices", "Differential Calculus", "Integral Calculus", "Vector Spaces", "Linear Algebra"],
    "21CSE101T": ["Introduction to C", "Arrays and Strings", "Functions and Pointers", "Structures and Unions", "File Handling"],
    "21EBE101T": ["DC Circuits", "AC Circuits", "Semiconductor Devices", "Transistors", "Digital Electronics Basics"],
    // Sem 2
    "21PYM101T": ["Electrostatics & Magnetostatics", "Maxwell's Equations", "Wave Optics", "Introduction to Quantum Mechanics", "Quantum Computing Basics"],
    "21MAB102T": ["First Order ODE", "Higher Order ODE", "Laplace Transforms", "Fourier Series", "Partial Differential Equations"],
    "21EPL101L": ["Vocabulary Building", "Basic Writing Skills", "Identifying Common Errors", "Presentation Skills", "Group Discussion"],
    "21CSE102J": ["Linked Lists", "Stacks and Queues", "Trees", "Graphs", "Sorting and Searching"],
    // Sem 3
    "21ECC201T": ["Semiconductor Junction Theory", "Special Junction Diodes and Applications", "Bipolar Junction Transistor", "Field Effect Transistor", "Fabrication of Semiconductor Devices"],
    "21ECC202T": ["Single and Multistage Amplifiers", "Introduction to Linear ICs", "Feedback Amplifiers and Oscillators", "Applications of Linear ICs-1", "Applications of Linear ICs - II"],
    "21ECC203T": ["Basics and Logic Family", "Combinational Circuits", "Sequential Circuits", "Advanced Combinational & Sequential Logic", "PLDs and Memory"],
    "21ECC204T": ["Classification of Signals and Systems", "Analysis of Continuous Time Signals", "Analysis of Discrete Time Signals", "Finite Impulse Response (FIR) Filter", "Infinite Impulse Response (IIR) Filter"],
    "21ECC205T": ["Electrostatics", "Magnetostatics and Maxwells Equations", "Electromagnetic Waves and Waveguides", "Transmission Line Theory", "Impedance Matching"],
    // Sem 4
    "21ECC401T": ["Intro to Wireless Communications & Antennas", "Large Scale Fading", "Small Scale Fading", "Improvement of link Performance", "Wireless Systems and Standards"],
    "21ECC402P": ["Data Communication and Networking", "Data Link Layer", "Networking Layer", "Network Security", "Security Attack"],
    "21ECE201J": ["Python Basics", "Modules and File I/O", "Features and Applications of NumPy", "Pandas and Difference Equation Modeling", "Random Process and Game Programming"],
    "21ECE202T": ["Deposition Technologies", "Etching and Lithography Techniques", "Nano-Fabrication by Self-Assembly", "Device and Circuit Fabrication", "Stamping Techniques"],
    "21ECE203J": ["Sensor Fundamentals and Characteristics", "Remote Sensing for Precision Agriculture", "Nano Sensors in Agriculture", "IoT-based Devices in Agriculture", "AI, Edge, and IoT Frameworks"],
    // Sem 5
    "21ECC301T": ["Discrete Fourier Transform", "FIR Filter Design", "IIR Filter Design", "Multirate Signal Processing", "DSP Processors"],
    "21ECC302T": ["MOS Transistor Theory", "CMOS Logic Circuits", "Layout & Design Rules", "Verilog HDL", "FPGA Architecture"],
    "21ECC303T": ["System Modeling", "Time Response Analysis", "Frequency Response Analysis", "Stability Analysis", "State Space Analysis"],
    "21ECC304T": ["Instruction Set Architecture", "CPU Design", "Pipelining", "Memory Hierarchy", "I/O Organization"],
    // Sem 6
    "21ECC305T": ["ARM Architecture", "Embedded C Programming", "RTOS", "Communication Protocols", "System Design Case Studies"],
    "21ECC306T": ["Microwave Network Theory", "Microwave Tubes", "Microwave Solid State Devices", "Microwave Antennas", "Microwave Measurements"],
    "21ECC307T": ["Optical Fibers", "Optical Sources", "Optical Detectors", "Optical Networks", "WDM Concepts"],
    "21ECE401T": ["Elective Topic A", "Elective Topic B", "Elective Topic C", "Elective Topic D", "Elective Topic E"],
    // Sem 7
    "21ECE405T": ["IoT Fundamentals", "IoT Protocols", "Edge Computing", "Cloud Integration", "IoT Case Studies"],
    "21ECE406T": ["Supervised Learning", "Unsupervised Learning", "Neural Networks", "Deep Learning", "Applications in ECE"],
    "21ECE402T": ["Elective Topic F", "Elective Topic G", "Elective Topic H", "Elective Topic I", "Elective Topic J"],
    "21EGP501P": ["Literature Survey", "Problem Formulation", "Methodology Design", "Initial Implementation", "Report Writing"],
    // Sem 8
    "21EGP502P": ["Final Implementation", "Testing and Validation", "Results Analysis", "Publication/Patent", "Final Report & Viva"],
    "21EGP503P": ["Industry Training", "Project Execution", "Weekly Reporting", "Final Presentation", "Internship Report"],
    "21EGP504V": ["Core Subjects Review", "Technical Quiz", "Group Discussion", "Interview", "Final Assessment"]
};

// Generate Mock Analysis and Question Bank Data
Object.keys(pyqs).forEach(sem => {
    Object.keys(pyqs[sem]).forEach(subCode => {
        const units = unitData[subCode];
        if (units) {
            units.forEach(unitName => pyqs[sem][subCode].units[unitName] = []);
            
            // Unit Weightage (Pie Chart)
            let weights = Array.from({length: 5}, () => Math.random());
            const total = weights.reduce((a, b) => a + b, 0);
            weights = weights.map(w => Math.round((w / total) * 100));
            while (weights.reduce((a, b) => a + b, 0) !== 100) { // Adjust sum to be exactly 100
                let diff = 100 - weights.reduce((a, b) => a + b, 0);
                weights[Math.floor(Math.random()*5)] += diff;
            }

            pyqs[sem][subCode].analysis = {
                unitLabels: units.map(u => u.split(' ')[0]), // Shorten for chart
                unitData: weights,
                topicLabels: ["Theory", "Numericals", "Derivations", "Diagrams", "Applications"],
                topicData: Array.from({length: 5}, () => Math.floor(Math.random() * 25) + 5)
            };
            
            // Question Bank
            pyqs[sem][subCode].questionBank = Array.from({length: 15}, (_, i) => ({
                text: `Explain a key concept from ${units[i % 5]}. Discuss its significance. (10 Marks)`,
                unit: units[i % 5],
                year: 2022 + (i % 3)
            }));

            // PYQ Files
            Object.keys(pyqs[sem][subCode].units).forEach(unitName => {
                for(let year = 2022; year <= 2024; year++){
                    pyqs[sem][subCode].units[unitName].push({
                        id: `${sem.replace(' ','')}-${subCode}-${unitName.replace(/[\s,&]/g,'')}-${year}`,
                        name: `PYQ - ${subCode} - ${year}.pdf`,
                        year: year,
                        tags: ["End-Sem", "Mid-Term", "Re-appear"][year % 3]
                    });
                }
            });
        }
    });
});

const leaderboardData = [
    { rank: 1, name: 'Ananya Sharma', points: 1250, uploads: 25, insta: 'ananya.sh' },
    { rank: 2, name: 'Rohan Verma', points: 1180, uploads: 22, insta: 'rohan_v' },
    { rank: 3, name: 'Priya Singh', points: 990, uploads: 18, insta: 'priya.s_official' },
    { rank: 4, name: 'Vikram Reddy', points: 850, uploads: 15, insta: 'vikram.reddy' },
    { rank: 5, name: 'Sneha Gupta', points: 720, uploads: 12, insta: 'sneha_g' }
];


// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    const semCol1 = document.getElementById('semester-col-1');
    const semCol2 = document.getElementById('semester-col-2');
    const semSelect = document.getElementById('upload-sem');

    let semCount = 0;
    for (const sem in pyqs) {
        let div = document.createElement('div');
        div.className = 'card';
        div.innerText = sem;
        div.onclick = () => showSemester(sem);
        
        if (semCount < 4) semCol1.appendChild(div);
        else semCol2.appendChild(div);
        semCount++;

        let opt = document.createElement('option');
        opt.value = sem;
        opt.textContent = sem;
        semSelect.appendChild(opt);
    }
    
    setTimeout(() => {
        checkAdStatus();
    }, 300);

    animateCardsInPage(document.getElementById('home'));

    const leaderboardBody = document.getElementById('leaderboard-body');
    leaderboardData.forEach(user => {
        leaderboardBody.innerHTML += `
            <tr>
                <td class="rank">${user.rank === 1 ? '<i class="fas fa-medal"></i>' : user.rank}</td>
                <td>${user.name}</td>
                <td>${user.points}</td>
                <td>${user.uploads}</td>
                <td><i class="fa-brands fa-instagram"></i> @${user.insta}</td>
            </tr>
        `;
    });
    
    document.addEventListener('click', (e) => {
        const searchContainer = document.querySelector('.search-container');
        if (!searchContainer.contains(e.target)) {
            document.getElementById('search-results').style.display = 'none';
        }
    });
});

// --- NAVIGATION & PAGE RENDERING ---
let isNavigating = false;
function showPage(pageId) {
    if (isNavigating) return;
    isNavigating = true;

    const targetPage = document.getElementById(pageId);
    if (!targetPage) { isNavigating = false; return; }

    const currentPage = document.querySelector('.page.visible');
    
    if (currentPage && currentPage.id === pageId) {
        isNavigating = false;
        return;
    }

    if (currentPage) {
        currentPage.classList.add('is-exiting');
        
        setTimeout(() => {
            currentPage.classList.remove('visible', 'is-exiting');
            
            targetPage.classList.add('visible');
            animateCardsInPage(targetPage);

            if (pageId === 'upload') {
                document.getElementById('upload-sem').value = '';
                populateUploadSubjects();
            }
            isNavigating = false;
        }, 500);
    } else {
        targetPage.classList.add('visible');
        animateCardsInPage(targetPage);
        isNavigating = false;
    }
}

function showSemester(sem) {
    currentSemester = sem;
    document.getElementById('semesterTitle').innerText = `${sem} - Subjects`;
    let subjectsDiv = document.getElementById('subjects');
    subjectsDiv.innerHTML = '';
    for (const subCode in pyqs[sem]) {
        let div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<strong>${subCode}</strong><br>${pyqs[sem][subCode].name}`;
        div.onclick = () => showSubject(sem, subCode);
        subjectsDiv.appendChild(div);
    }
    showPage('semesterPage');
}

function showSubject(sem, subCode) {
    currentSemester = sem;
    currentSubject = subCode;
    document.getElementById('subjectTitle').innerText = `${subCode} - ${pyqs[sem][subCode].name}`;
    let unitsDiv = document.getElementById('units');
    unitsDiv.innerHTML = '';
    for (const unit in pyqs[sem][subCode].units) {
        let div = document.createElement('div');
        div.className = 'card';
        div.innerText = unit;
        div.onclick = () => showUnit(sem, subCode, unit);
        unitsDiv.appendChild(div);
    }
    showPage('subjectPage');
}

function showUnit(sem, subCode, unit) {
    currentSemester = sem;
    currentSubject = subCode;
    currentUnit = unit;
    document.getElementById('unitTitle').innerText = `${unit} - PYQs`;
    let pyqDiv = document.getElementById('pyqList');
    pyqDiv.innerHTML = '';
    if (pyqs[sem][subCode].units[unit].length === 0) {
        pyqDiv.innerHTML = '<p style="text-align: center; opacity: 0.7;">No question papers available for this unit yet. Be the first to upload!</p>';
    } else {
        pyqs[sem][subCode].units[unit].forEach(pyq => {
            pyqDiv.innerHTML += `
            <div class="pyq-item" id="pyq-item-${pyq.id}">
                <div class="pyq-header">
                    <span class="pyq-title">${pyq.name}</span>
                    <div class="pyq-tags">${pyq.tags ? `<span class="pyq-tag">${pyq.tags}</span>` : ''}</div>
                </div>
                <div class="stars" data-pyqid="${pyq.id}">
                    ${[1,2,3,4,5].map(i => `<i class="fa-regular fa-star" data-value="${i}" onclick="handleRating('${pyq.id}', ${i})"></i>`).join('')}
                </div>
                <div class="pyq-actions">
                    <button class="pyq-btn" onclick="viewPDF('${pyq.id}')"><i class="fas fa-eye"></i> View PDF</button>
                    <button class="pyq-btn" onclick="toggleComments('${pyq.id}')"><i class="fas fa-comments"></i> Rate & Comment</button>
                    <button class="pyq-btn primary" onclick="startExamSimulator('${pyq.id}')"><i class="fas fa-stopwatch"></i> Practice Mode</button>
                </div>
                <div class="rating-comment-section" id="rc-${pyq.id}">
                    <div class="comment-box">
                        <textarea id="comment-${pyq.id}" placeholder="How was this paper? Add a public comment..."></textarea>
                        <button class="pyq-btn" style="margin-top: 10px; flex-grow: 0;" onclick="saveComment('${pyq.id}')">Post Comment</button>
                        <div id="comments-list-${pyq.id}" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </div>
            `;
        });
    }
    pyqs[sem][subCode].units[unit].forEach(pyq => {
        updateRatingDisplay(pyq.id);
        loadComments(pyq.id);
    });
    showPage('unitPage');
    animateCardsInPage(document.getElementById('unitPage'));
}

// --- FEATURE IMPLEMENTATION ---

// Smart Search
function handleSearch() {
    const query = document.getElementById('search-bar').value.toLowerCase();
    const resultsDiv = document.getElementById('search-results');
    if (query.length < 3) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    let results = [];
    for (const sem in pyqs) {
        for (const subCode in pyqs[sem]) {
            const subject = pyqs[sem][subCode];
            const subjectName = subject.name.toLowerCase();
            if (subjectName.includes(query) || subCode.toLowerCase().includes(query)) {
                results.push({ type: 'Subject', name: subject.name, code: subCode, context: sem });
            }
        }
    }
    
    resultsDiv.innerHTML = results.slice(0, 5).map(r => `
        <div class="search-result-item" onclick="showSubject('${r.context}', '${r.code}'); document.getElementById('search-results').style.display='none'; document.getElementById('search-bar').value='${r.name}';">
            <strong>${r.code}: ${r.name}</strong><small>${r.context}</small>
        </div>`).join('');

    resultsDiv.style.display = results.length > 0 ? 'block' : 'none';
}

// Subject Analysis
function showSubjectAnalysis(subCode) {
    const subject = pyqs[currentSemester][subCode];
    document.getElementById('analysisTitle').innerText = `Analysis for ${subCode}`;
    showPage('subjectAnalysisPage');
    
    const unitCtx = document.getElementById('unitWeightageChart').getContext('2d');
    if(unitChartInstance) unitChartInstance.destroy();
    unitChartInstance = new Chart(unitCtx, {
        type: 'pie',
        data: {
            labels: subject.analysis.unitLabels,
            datasets: [{
                data: subject.analysis.unitData,
                backgroundColor: ['#36a2eb', '#ff6384', '#ffce56', '#4bc0c0', '#9966ff'],
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } } }
    });

    const topicCtx = document.getElementById('topicChart').getContext('2d');
    if(topicChartInstance) topicChartInstance.destroy();
    topicChartInstance = new Chart(topicCtx, {
        type: 'bar',
        data: {
            labels: subject.analysis.topicLabels,
            datasets: [{
                data: subject.analysis.topicData,
                backgroundColor: '#36a2eb',
                borderRadius: 5
            }]
        },
        options: {
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });
}

// Question Bank
function showQuestionBank(subCode) {
    const subject = pyqs[currentSemester][subCode];
    document.getElementById('questionBankTitle').innerText = `Question Bank for ${subCode}`;
    const unitFilter = document.getElementById('unitFilter');
    unitFilter.innerHTML = '<option value="all">All Units</option>';
    Object.keys(subject.units).forEach(unit => {
        unitFilter.innerHTML += `<option value="${unit}">${unit}</option>`;
    });
    renderQuestionBank(subCode);
    showPage('questionBankPage');
}

function renderQuestionBank(subCode) {
    const listDiv = document.getElementById('questionBankList');
    const filterValue = document.getElementById('unitFilter').value;
    const questions = pyqs[currentSemester][subCode].questionBank;
    
    listDiv.innerHTML = '';
    const filteredQuestions = filterValue === 'all' ? questions : questions.filter(q => q.unit === filterValue);

    filteredQuestions.forEach(q => {
        listDiv.innerHTML += `
            <div class="question-item">
                <p>${q.text}</p>
                <small><strong>Unit:</strong> ${q.unit} | <strong>Appeared in:</strong> ${q.year}</small>
            </div>
        `;
    });
}

// Rating & Comments
function toggleComments(pyqId) {
    const section = document.getElementById(`rc-${pyqId}`);
    section.style.display = section.style.display === 'block' ? 'none' : 'block';
}

function handleRating(pyqId, value) {
    localStorage.setItem(`rating_${pyqId}`, value);
    updateRatingDisplay(pyqId);
}

function updateRatingDisplay(pyqId) {
    const rating = localStorage.getItem(`rating_${pyqId}`) || 0;
    const item = document.getElementById(`pyq-item-${pyqId}`);
    if (!item) return;
    const stars = item.querySelectorAll(`.stars .fa-star`);
    stars.forEach(star => {
        const starValue = parseInt(star.dataset.value, 10);
        const isSelected = starValue <= rating;
        
        star.classList.toggle('selected', isSelected);
        if(isSelected) {
            star.classList.remove('fa-regular');
            star.classList.add('fa-solid');
        } else {
            star.classList.remove('fa-solid');
            star.classList.add('fa-regular');
        }
    });
}

function saveComment(pyqId) {
    const textarea = document.getElementById(`comment-${pyqId}`);
    const commentText = textarea.value.trim();
    if (commentText) {
        const comments = JSON.parse(localStorage.getItem(`comments_${pyqId}`)) || [];
        comments.push(commentText);
        localStorage.setItem(`comments_${pyqId}`, JSON.stringify(comments));
        textarea.value = '';
        loadComments(pyqId);
    }
}

function loadComments(pyqId) {
    const commentsList = document.getElementById(`comments-list-${pyqId}`);
    if (!commentsList) return;
    const comments = JSON.parse(localStorage.getItem(`comments_${pyqId}`)) || [];
    commentsList.innerHTML = comments.map(c => `<div class="question-item" style="margin-bottom: 0.5rem; padding: 0.8rem;"><p>${c}</p></div>`).reverse().join('');
}


// View PDF
function viewPDF(pyqId) {
    let pyqToView = null;
    for (const sem in pyqs) {
        for (const subCode in pyqs[sem]) {
            for (const unit in pyqs[sem][subCode].units) {
                const found = pyqs[sem][subCode].units[unit].find(p => p.id === pyqId);
                if (found) {
                    pyqToView = found;
                    break;
                }
            }
            if (pyqToView) break;
        }
        if (pyqToView) break;
    }

    if (pyqToView) {
        if (pyqToView.fileURL) {
            window.open(pyqToView.fileURL, '_blank');
        } else {
            const pdfPlaceholderHTML = `
                <body style="margin:0; font-family: sans-serif; background: #333; color: white; text-align: center; padding-top: 50px;">
                    <h1>📄 PDF Preview Placeholder</h1>
                    <p>This is a demonstration for a pre-loaded paper.</p>
                    <p>The PDF for <strong>${pyqToView.name}</strong> would be displayed here.</p>
                </body>
            `;
            const newTab = window.open();
            newTab.document.write(pdfPlaceholderHTML);
            newTab.document.close();
        }
    } else {
        alert("Sorry, the selected paper could not be found.");
    }
}

// Exam Simulator
function startExamSimulator(pyqId) {
    let pyqToView = null;
    for (const sem in pyqs) {
        for (const subCode in pyqs[sem]) {
            for (const unit in pyqs[sem][subCode].units) {
                const found = pyqs[sem][subCode].units[unit].find(p => p.id === pyqId);
                if (found) {
                    pyqToView = found;
                    break;
                }
            }
            if (pyqToView) break;
        }
        if (pyqToView) break;
    }

    if (!pyqToView) {
        alert("Sorry, the selected paper could not be found for the exam simulator.");
        return;
    }

    const modal = document.getElementById('exam-simulator');
    const paperView = document.getElementById('sim-paper-view');

    if (pyqToView.fileURL) {
        paperView.innerHTML = `<iframe src="${pyqToView.fileURL}" width="100%" height="100%" style="border:none;" title="${pyqToView.name}"></iframe>`;
    } else {
        paperView.innerHTML = `<p style="padding: 20px;">Live preview is only available for papers you have uploaded yourself. For pre-loaded papers, please use the "View PDF" button to see the placeholder.</p>`;
    }

    document.getElementById('sim-paper-title').innerText = pyqToView.name;
    modal.style.display = 'flex';
    isPaused = false;
    remainingTime = 3 * 60 * 60;
    document.getElementById('pause-btn-text').textContent = " Pause";
    
    if (examTimerInterval) clearInterval(examTimerInterval);
    examTimerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    if (isPaused) return;
    remainingTime--;
    const hours = Math.floor(remainingTime / 3600).toString().padStart(2, '0');
    const minutes = Math.floor((remainingTime % 3600) / 60).toString().padStart(2, '0');
    const seconds = (remainingTime % 60).toString().padStart(2, '0');
    document.getElementById('sim-timer').innerText = `${hours}:${minutes}:${seconds}`;
    if (remainingTime <= 0) {
        clearInterval(examTimerInterval);
        alert("Time's up!");
        stopExamSimulator();
    }
}

function toggleTimer() {
    isPaused = !isPaused;
    const pauseBtnText = document.getElementById('pause-btn-text');
    pauseBtnText.textContent = isPaused ? " Resume" : " Pause";
}

function stopExamSimulator() {
    clearInterval(examTimerInterval);
    document.getElementById('exam-simulator').style.display = 'none';
    document.getElementById('sim-timer').innerText = '03:00:00';
    document.getElementById('sim-paper-view').innerHTML = '<p>Simulated PDF view of the paper appears here.</p>';
}


// --- UTILITY FUNCTIONS ---
function isAdFree(){return localStorage.getItem('adFree')==='true';}

function checkAdStatus(){
    const adSidebars = document.querySelectorAll('.ad-sidebar');
    const adBlock = document.getElementById('ad-block');
    if (isAdFree()) {
        adSidebars.forEach(bar => bar.classList.remove('visible'));
    } else {
        if (adBlock) {
            adBlock.innerHTML = `<div><p>👋 Support Us & Get an <strong>AD-FREE</strong> Experience!</p><button class="support-btn" onclick="showPage('upload')">Upload a Paper</button></div>`;
        }
        adSidebars.forEach(bar => bar.classList.add('visible'));
    }
}

function handleSuccessfulUpload(){
    const sem = document.getElementById('upload-sem').value;
    const subCode = document.getElementById('upload-sub').value;
    const unit = document.getElementById('upload-unit').value;
    const fileInput = document.getElementById('upload-file');
    const wantsFeature = document.getElementById('feature-me').checked;

    if (!sem || !subCode || !unit || fileInput.files.length === 0) {
        alert('Please fill out all fields and select a file.');
        return; 
    }

    const file = fileInput.files[0];
    const fileName = file.name;
    const fileURL = URL.createObjectURL(file);

    const newPyq = {
        id: `${sem.replace(' ','')}-${subCode}-${unit.replace(/[\s,&]/g,'')}-${new Date().getTime()}`, 
        name: fileName,
        year: new Date().getFullYear(),
        tags: "User Upload",
        fileURL: fileURL 
    };
    
    if (pyqs[sem] && pyqs[sem][subCode] && pyqs[sem][subCode].units[unit]) {
         pyqs[sem][subCode].units[unit].push(newPyq);
    } else {
         alert('An error occurred while trying to save the file data. Please try again.');
         return;
    }
    
    alert(`✅ Success! Your paper "${fileName}" has been added. You now have a TIER 1 AD-FREE experience! ${wantsFeature ? 'You may be featured on our leaderboard soon!' : ''}`);
    localStorage.setItem('adFree','true');
    document.querySelector('#upload form').reset();
    populateUploadSubjects(); 
    checkAdStatus(); 
    showPage('home');
}

function animateCardsInPage(pageElement) {
    if (!pageElement) return;
    const cards = pageElement.querySelectorAll('.card, .pyq-item');
    cards.forEach((card, index) => {
        card.style.animation = 'none';
        requestAnimationFrame(() => {
            card.style.animation = `cardFadeInUp 0.7s var(--ease-out-back) ${index * 0.06}s forwards`;
        });
    });
}

function populateUploadSubjects() {
    const semSelect = document.getElementById('upload-sem');
    const subSelect = document.getElementById('upload-sub');
    const selectedSemester = semSelect.value;
    subSelect.innerHTML = '<option value="">-- Select Subject --</option>';
    populateUploadUnits();
    if (selectedSemester && pyqs[selectedSemester]) {
        for (const subCode in pyqs[selectedSemester]) {
            let opt = document.createElement('option');
            opt.value = subCode;
            opt.textContent = `${subCode} - ${pyqs[selectedSemester][subCode].name}`;
            subSelect.appendChild(opt);
        }
        subSelect.disabled = false;
    } else {
        subSelect.disabled = true;
    }
}

function populateUploadUnits() {
    const semSelect = document.getElementById('upload-sem');
    const subSelect = document.getElementById('upload-sub');
    const unitSelect = document.getElementById('upload-unit');
    const selectedSemester = semSelect.value;
    const selectedSubject = subSelect.value;
    unitSelect.innerHTML = '<option value="">-- Select Unit --</option>';
    if (selectedSemester && selectedSubject && pyqs[selectedSemester] && pyqs[selectedSemester][selectedSubject]) {
        for (const unit in pyqs[selectedSemester][selectedSubject].units) {
            let opt = document.createElement('option');
            opt.value = unit;
            opt.textContent = unit;
            unitSelect.appendChild(opt);
        }
        unitSelect.disabled = false;
    } else {
        unitSelect.disabled = true;
    }
}

// --- UPDATED FUNCTION FOR THOROUGH BULK UPLOADING ---
function populateAllSubjects(fileObject) {
    if (!fileObject || !(fileObject instanceof File)) {
        console.error("Error: Please provide a valid File object. You can get one from the file input, e.g., document.getElementById('upload-file').files[0]");
        alert("Bulk upload failed. Please select a file on the Upload page first, then run the command again.");
        return;
    }

    console.log(`Starting thorough bulk upload for file: ${fileObject.name}`);
    let count = 0;
    // Create the temporary URL once for efficiency
    const fileURL = URL.createObjectURL(fileObject);

    // Iterate through every semester
    for (const sem in pyqs) {
        // Iterate through every subject in that semester
        for (const subCode in pyqs[sem]) {
            const subject = pyqs[sem][subCode];
            
            if (subject.units && Object.keys(subject.units).length > 0) {
                // Iterate through every unit in that subject
                for (const unitName in subject.units) {
                    const newPyq = {
                        // Add count to timestamp to ensure unique ID in fast loops
                        id: `${sem.replace(' ','')}-${subCode}-${unitName.replace(/[\s,&]/g,'')}-bulk-${new Date().getTime() + count}`,
                        name: fileObject.name,
                        year: new Date().getFullYear(),
                        tags: "Bulk Upload",
                        fileURL: fileURL // Use the same URL for all
                    };

                    // Add the new file object to this specific unit
                    pyqs[sem][subCode].units[unitName].push(newPyq);
                    count++;
                }
            }
        }
    }

    console.log(`✅ Success! Added '${fileObject.name}' to ${count} different unit lists.`);
    alert(`✅ Success! Added '${fileObject.name}' to ${count} different unit lists. The file is now in every unit of every subject.`);
}
</script>

</body>
</html>
